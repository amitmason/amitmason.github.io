DeleteCard=true;DeletePat=true;MJdebugAI=false;MJdebugPICK=false;MJdebugEAT=false;MJdebugLISTEN=false;MJdebugPONG=false;MJdebugGUNG=false;MJdebugDESK=false;Mjtype=["筒","萬","條","字"];Mjnum=["一","二","三","四","五","六","七","八","九"];Mjword=["東","南","西","北","中","發","白","花","季"];Mjseason=["春","夏","秋","冬"];Mjflower=["梅","蘭","竹","菊"];function showAlert(str){alert(str)}function showConsole(text){}function onemj(n,t,i){if(t>=0&&t<4)this.t=t;else showAlert("onemj wrong input: t="+t);if(n>=0&&n<9)this.n=n;else showAlert("onemj wrong input: n="+n);if(i>=0&&i<4)this.i=i;else showAlert("onemj wrong input: i="+i);this.mesh=null;this.markdown=false;this.markeat=false}function cardswap(k,j){var c;if(k<this.card.length&&j<this.card.length){c=this.card[j];this.card[j]=this.card[k];this.card[k]=c}else{showAlert("cardswap index error")}}function cardshuffle(){var j,k;var cardlen;cardlen=this.card.length;for(k=0;k<cardlen;k+=2){if(k+1<cardlen)this.swap(k,k+1)}for(k=0;k<cardlen;k++){j=Math.floor(Math.random()*cardlen);if(j!=k){if(j<cardlen)this.swap(k,j)}}}function cardremove(e){var k,c;var cardlen,found;found=false;cardlen=this.card.length;for(k=0;k<cardlen;k++){c=this.card[k];if(e.t==c.t&&e.n==c.n&&e.i==c.i){c.mesh.dispose();c.mesh=null;this.swap(k,cardlen-1);found=true;break}else{showAlert("cardremove can not find");break}}if(found)this.card.pop()}function carddecode(e){var s;if(e.t!=3||e.n<7){if(e.t<3)s=Mjnum[e.n]+Mjtype[e.t];else if(e.n<7)s=Mjword[e.n];else if(e.n==8)s=Mjseason[e.i]+Mjword[e.n];else if(e.i==2)s=Mjflower[e.i]+"子";else s=Mjflower[e.i]+Mjword[e.n];return s}else{showAlert("carddecode out of range");s=""}}function cardpattern(t,pattern){var x,s;var j,n,i;x=[];for(j=0,i=0;j<pattern.length;j++){n=pattern[j];if(t!=3||n<7){if(t<3)s=Mjnum[n]+Mjtype[t];else if(n<7)s=Mjword[n];else if(n==8)s=Mjseason[i]+Mjword[n];else if(i==2)s=Mjflower[i]+"子";else s=Mjflower[i]+Mjword[n];x.push(s)}else{showAlert("cardpattern out of range");break}}return x}function carddump(){var s,cardlen,d,k,j;k=0;cardlen=this.card.length;s=this.name+cardlen+"張:";while(k<cardlen){d=carddecode(this.card[k]);if(k%18==17){showConsole(s);s=d+","}else s=s+d+",";k++}cardlen=this.desk.length;if(MJdebugDESK){s=s+"\n麻將牌"+cardlen+"組:";for(j=0;j<cardlen;j++)s=s+"["+this.desk[j]+"],"}showConsole(s)}function cardsort(){var j,k,cardlen,minidx;var cardt;cardt=this.card;cardlen=this.card.length;for(k=0;k<cardlen;k++){minidx=k;for(j=k+1;j<cardlen;j++){if(cardt[j].t<cardt[minidx].t)minidx=j}if(k!=minidx)this.swap(k,minidx)}for(k=0;k<cardlen;k++){minidx=k;for(j=k+1;j<cardlen;j++){if(cardt[j].t!=cardt[k].t)break;if(cardt[j].n<cardt[minidx].n)minidx=j}if(k!=minidx)this.swap(k,minidx)}for(k=0;k<cardlen;k++){minidx=k;for(j=k+1;j<cardlen;j++){if(cardt[j].t!=cardt[k].t||cardt[j].n!=cardt[k].n)break;if(cardt[j].i<cardt[minidx].i)minidx=j}if(k!=minidx)this.swap(k,minidx)}}function sortmj(decend){var j,k,cardlen,minidx;var cardt;cardt=this.card;cardlen=this.card.length;if(arguments.length<1)decend=false;for(k=0;k<cardlen;k++){minidx=k;for(j=k+1;j<cardlen;j++){if(decend){if(cardt[j].t>cardt[minidx].t)minidx=j}else{if(cardt[j].t<cardt[minidx].t)minidx=j}}if(k!=minidx)this.swap(k,minidx)}for(k=0;k<cardlen;k++){minidx=k;for(j=k+1;j<cardlen;j++){if(cardt[j].t!=cardt[k].t)break;if(decend){if(cardt[j].n>cardt[minidx].n)minidx=j}else{if(cardt[j].n<cardt[minidx].n)minidx=j}}if(k!=minidx)this.swap(k,minidx)}for(k=0;k<cardlen;k++){minidx=k;for(j=k+1;j<cardlen;j++){if(cardt[j].t!=cardt[k].t||cardt[j].n!=cardt[k].n)break;if(decend){if(cardt[j].i>cardt[minidx].i)minidx=j}else{if(cardt[j].i<cardt[minidx].i)minidx=j}}if(k!=minidx)this.swap(k,minidx)}}function tmatch(cardt,t,pattern){var c;var j,k,n;var pp,pplen,count;count=0;pp=pattern.slice(0);for(j=0;j<cardt.length;j++){c=cardt[j];if(c.t==t){pplen=pp.length;for(k=0;k<pplen;k++){n=pp[k];if(c.n==n){count++;if(k!=pplen-1){pp[k]=pp[pplen-1];pp[pplen-1]=n}pp.pop();break}}}}if(DeletePat)delete pp;return count}function dropMatch(cardt,t,pp){var c;var j,k;var cardlen,found;for(j=0;j<pp.length;j++){cardlen=cardt.length;found=false;for(k=0;k<cardlen;k++){c=cardt[k];if(c.t==t&&c.n==pp[j]){found=true;if(k!=cardlen-1){cardt[k]=cardt[cardlen-1];cardt[cardlen-1]=c}break}}if(found)cardt.pop()}}function patternMatch(cardt,t,pattern){return tmatch(cardt,t,pattern)==pattern.length}function dropToDesk(t,pp,markdown,n){var c;var j,k;var cardlen,found;var cardt;var markeat;if(arguments.length<3||pp.length!=4)markdown=false;if(arguments.length>=4&&pp.length==3&&t!=3){if(pp[1]!=n){if(pp[0]==n){pp[0]=pp[1];pp[1]=n}else if(pp[2]==n){pp[2]=pp[1];pp[1]=n}}markeat=true}else markeat=false;cardt=this.card;for(j=0;j<pp.length;j++){cardlen=cardt.length;for(k=0;k<cardlen;k++){c=cardt[k];if(c.t==t&&c.n==pp[j]){found=true;if(markeat){if(c.n==n)c.markeat=true}else c.markeat=false;if(markdown&&j==2)c.markdown=false;else c.markdown=markdown;if(k!=cardlen-1){cardt[k]=cardt[cardlen-1];cardt[cardlen-1]=c}break}}if(found)this.desk.push(cardt.pop())}}function matchtime(cardt,t,n){var found,j;found=0;for(j=0;j<cardt.length;j++){if(cardt[j].t==t&&cardt[j].n==n)found++}return found}function isListen(){var t,j,k;var p,cardhu,clone2;var p2,found;function listenMatchB(p,calldrop3){for(j=0;j<x.length;j++){clone2=cardhu.slice(0);dropMatch(clone2,x[j].t,[x[j].n,x[j].n]);calldrop3(clone2,p);if(clone2.length==2){if(clone2[0].t==clone2[1].t&&clone2[0].n==clone2[1].n){found=true;break}if(!found){for(t=0;t<3;t++){for(k=0;k<p2.length;k++){if(patternMatch(clone2,t,p2[k])){found=true;break}}if(found)break}}}if(DeleteCard)delete clone2}}cardhu=this.card;x=[];for(j=0;j<cardhu.length;j++){if(matchtime(cardhu,cardhu[j].t,cardhu[j].n)>=2){found=false;for(k=0;k<x.length;k++){if(x[k].t==cardhu[j].t&&x[k].n==cardhu[j].n){found=true;break}}if(!found)x.push(cardhu[j])}}p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);clone2=cardhu.slice(0);hulaDrop3(clone2,p);if(clone2.length==1){if(DeletePat)delete p;if(DeleteCard)delete clone2;if(DeleteCard)delete cardhu;return true}if(DeleteCard)delete clone2;clone2=cardhu.slice(0);hulaDrop3B(clone2,p);if(clone2.length==1){if(DeletePat)delete p;if(DeleteCard)delete clone2;if(DeleteCard)delete cardhu;return true}if(DeleteCard)delete clone2;found=false;p2=[];for(k=0;k<7;k++){p2.push([k,k+1]);p2.push([k,k+2])}p2.push([7,8]);found=false;listenMatchB(p,hulaDrop3);if(!found)listenMatchB(p,hulaDrop3B);if(!found){if(DeletePat)delete p;p=[];for(k=6;k>=0;k--)p.push([k,k+1,k+2]);listenMatchB(p,hulaDrop3)}if(DeletePat)delete p2;if(DeletePat)delete p;if(DeletePat)delete x;if(DeleteCard)delete cardhu;return found}function listendrop(){var t,j,k;var p,cardhu,clone2;var cardlen;var x,mjpair;var p2,found;function listenMatch(p,calldrop3){for(j=0;j<x.length;j++){clone2=cardhu.slice(0);dropMatch(clone2,x[j].t,[x[j].n,x[j].n]);calldrop3(clone2,p);cardlen=clone2.length;if(cardlen==0)found=true;else if(cardlen==3){for(k=0;k<3;k++){if(matchtime(clone2,clone2[k].t,clone2[k].n)>=2){dropMatch(cardhu,clone2[k].t,[clone2[k].n,clone2[k].n]);found=true;break}}if(!found){for(t=0;t<3;t++){for(k=0;k<p2.length;k++){if(patternMatch(clone2,t,p2[k])){dropMatch(cardhu,t,p2[k]);found=true;break}}if(found)break}}}if(DeleteCard)delete clone2;if(found){mjpair=x[j];break}}}cardhu=this.card;x=[];for(j=0;j<cardhu.length;j++){if(matchtime(cardhu,cardhu[j].t,cardhu[j].n)>=2){found=false;for(k=0;k<x.length;k++){if(x[k].t==cardhu[j].t&&x[k].n==cardhu[j].n){found=true;break}}if(!found)x.push(cardhu[j])}}found=false;p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);clone2=cardhu.slice(0);hulaDrop3(clone2,p);if(clone2.length==2){found=true;hulaDrop3(cardhu,p);if(DeletePat)delete p;if(DeleteCard)delete cardhu;if(DeleteCard)delete clone2;return found}if(DeleteCard)delete clone2;clone2=cardhu.slice(0);hulaDrop3B(clone2,p);if(clone2.length==2){found=true;hulaDrop3(cardhu,p);if(DeletePat)delete p;if(DeleteCard)delete cardhu;if(DeleteCard)delete clone2;return found}if(DeleteCard)delete clone2;p2=[];for(k=0;k<7;k++){p2.push([k,k+1]);p2.push([k,k+2])}p2.push([7,8]);found=false;listenMatch(p,hulaDrop3);if(!found)listenMatch(p,hulaDrop3B);if(!found){if(DeletePat)delete p;p=[];for(k=6;k>=0;k--)p.push([k,k+1,k+2]);listenMatch(p,hulaDrop3)}if(found){dropMatch(cardhu,mjpair.t,[mjpair.n,mjpair.n]);hulaDrop3(cardhu,p)}if(DeletePat)delete p2;if(DeletePat)delete x;if(DeletePat)delete p;if(DeleteCard)delete cardhu;return found}function listendropAA(){var status=0;var j,k,t;var p,cardhu;var guang;cardhu=this.card;p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);for(t=0;t<3;t++){for(j=0;j<p.length;j++){for(k=0;k<4;k++){if(patternMatch(cardhu,t,p[j]))dropMatch(cardhu,t,p[j])}}}if(DeletePat)delete p;for(t=0;t<4;t++){for(j=0;j<9;j++){if(t!=3||j<7){if(matchtime(cardhu,t,j)>=3)dropMatch(cardhu,t,[j,j,j])}}}if(cardhu.length==2){if(cardhu[0].t==cardhu[1].t&&cardhu[0].n==cardhu[1].n)status=1;else status=2}else if(cardhu.length==5){for(t=0;t<4;t++){for(j=0;j<9;j++){if(t!=3||j<7){if(matchtime(cardhu,t,j)>=2)dropMatch(cardhu,t,[j,j])}}}if(cardhu.length==1)status=3;else if(cardhu.length==3){p=[];for(k=0;k<7;k++){p.push([k,k+1]);p.push([k,k+2])}p.push([7,8]);for(t=0;t<3;t++){for(j=0;j<p.length;j++){if(patternMatch(cardhu,t,p[j]))dropMatch(cardhu,t,p[j])}}if(cardhu.length==1)status=4;if(DeletePat)delete p}}return status}function listdrop(){var i,j,k,t;var pat,p;var clone,cardhu;clone=this.card.slice(0);pat=[0,1,2,3,4,5,6,7,8];for(t=0;t<3;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){if(patternMatch(cardhu,t,pat))dropMatch(cardhu,t,pat);if(cardhu.length>0)cardhu=this.card;else break}}else break;if(DeletePat)delete pat}p=[];for(k=0;k<2;k++)p.push([k,k+1,k+2,k+3,k+4,k+5,k+6,k+7]);for(t=0;t<3;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<p.length;j++){pat=p[j];if(patternMatch(cardhu,t,pat))dropMatch(cardhu,t,pat)}if(cardhu.length>0)cardhu=this.card;else break}}else break}if(DeletePat)delete p;p=[];for(k=0;k<3;k++)p.push([k,k+1,k+2,k+3,k+4,k+5,k+6]);for(t=0;t<3;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<p.length;j++){pat=p[j];if(patternMatch(cardhu,t,pat))dropMatch(cardhu,t,pat)}if(cardhu.length>0)cardhu=this.card;else break}}else break}if(DeletePat)delete p;p=[];for(k=0;k<4;k++)p.push([k,k+1,k+2,k+3,k+4,k+5]);for(t=0;t<3;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<p.length;j++){pat=p[j];for(i=0;i<2;i++){if(patternMatch(cardhu,t,pat))dropMatch(cardhu,t,pat)}}if(cardhu.length>0)cardhu=this.card;else break}}else break}if(DeletePat)delete p;p=[];for(k=0;k<5;k++)p.push([k,k+1,k+2,k+3,k+4]);for(t=0;t<3;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<p.length;j++){pat=p[j];for(i=0;i<2;i++){if(patternMatch(cardhu,t,pat))dropMatch(cardhu,t,pat)}}if(cardhu.length>0)cardhu=this.card;else break}}else break}if(DeletePat)delete p;p=[];p.push([0,0,0,1,2]);for(k=0;k<7;k++)p.push([k,k+1,k+1,k+1,k+2]);p.push([6,7,8,8,8]);for(t=0;t<3;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<p.length;j++){pat=p[j];for(i=0;i<4;i++){if(patternMatch(cardhu,t,pat))dropMatch(cardhu,t,pat)}}if(cardhu.length>0)cardhu=this.card;else break}}else break}if(DeletePat)delete p;p=[];for(k=1;k<7;k++){p.push([k,k,k,k+1]);p.push([k,k+1,k+1,k+1])}for(t=0;t<3;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<p.length;j++){pat=p[j];for(i=0;i<4;i++){if(patternMatch(cardhu,t,pat))dropMatch(cardhu,t,pat)}}if(cardhu.length>0)cardhu=this.card;else break}}else break}if(DeletePat)delete p;for(t=0;t<4;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<9;j++){if(t!=3||j<7){if(matchtime(cardhu,t,j)>=3)dropMatch(cardhu,t,[j,j,j])}}if(cardhu.length>0)cardhu=this.card;else break}}else break}p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);for(t=0;t<3;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<p.length;j++){pat=p[j];for(i=0;i<4;i++){if(patternMatch(cardhu,t,pat))dropMatch(cardhu,t,pat)}}if(cardhu.length>0)cardhu=this.card;else break}}else break}if(DeletePat)delete p;p=[];for(k=1;k<7;k++){p.push([k,k+1])}for(t=0;t<3;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<p.length;j++){pat=p[j];for(i=0;i<4;i++){if(patternMatch(cardhu,t,pat))dropMatch(cardhu,t,pat)}}if(cardhu.length>0)cardhu=this.card;else break}}else break}if(DeletePat)delete p;for(t=0;t<4;t++){cardhu=clone;if(cardhu.length>0){for(k=0;k<2;k++){for(j=0;j<9;j++){if(t!=3||j<7){if(matchtime(cardhu,t,j)>=2)dropMatch(cardhu,t,[j,j])}}if(cardhu.length>0)cardhu=this.card;else break}}else break}this.sortmj();if(MJdebugAI){this.dump()}if(DeleteCard)delete clone;k=this.card.length;for(t=0;t<4;t++){for(j=0;j<9;j++){if(t!=3||j<7){if(matchtime(this.card,t,j)>=2)k--}}}return k}function cardpong(e){var j;var cardhu,clone,p;var aimin;var status;function matchn(cardt,pattern){var j,k,n;n=0;for(j=0;j<pattern.length;j++){for(k=0;k<cardt.length;k++){if(pattern[j]==cardt[k].n){n++;break}}}if(n==pattern.length)return true;else return false}function matcht(cardt,n){var t,k;t=0;for(k=0;k<cardt.length;k++){if(n==cardt[k].n)t++}return t}function pongDrop3(cardt,t,p){var j,k;for(j=0;j<p.length;j++){for(k=0;k<4;k++){if(matchn(cardt,p[j]))dropMatch(cardt,t,p[j])}}for(j=0;j<9;j++){if(matcht(cardt,j)>=3)dropMatch(cardt,t,[j,j,j])}}status=false;if(matchtime(this.card,e.t,e.n)==2){if(e.t==3)return true;p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);cardhu=[];for(j=0;j<this.card.length;j++){if(e.t==this.card[j].t)cardhu.push(this.card[j])}clone=cardhu.slice(0);pongDrop3(cardhu,e.t,p);dropMatch(clone,e.t,[e.n,e.n]);pongDrop3(clone,e.t,p);if(clone.length<cardhu.length)status=true;if(DeletePat)delete p;if(DeleteCard)delete clone;if(DeleteCard)delete cardhu}return status}function cardeat(e){var j,k,m,n;var cardhu,clone,p2,p3,p3a,p3b,pp;var aimin,x,found;var big,small;x=null;function matchn(cardt,pattern){var j,k,n;n=0;for(j=0;j<pattern.length;j++){for(k=0;k<cardt.length;k++){if(pattern[j]==cardt[k].n){n++;break}}}if(n==pattern.length)return true;else return false}function matcht(cardt,n){var t,k;t=0;for(k=0;k<cardt.length;k++){if(n==cardt[k].n)t++}return t}if(this.card.length>3&&e.t<3){cardhu=[];for(j=0;j<this.card.length;j++){if(e.t==this.card[j].t)cardhu.push(this.card[j])}if(cardhu.length>1){switch(e.n){case 0:p2=[[1,2]];break;case 1:p2=[[0,2],[2,3]];break;case 2:p2=[[0,1],[1,3],[3,4]];break;case 3:p2=[[2,4],[1,2],[4,5]];break;case 4:p2=[[3,5],[2,3],[5,6]];break;case 5:p2=[[4,6],[3,4],[6,7]];break;case 6:p2=[[7,8],[5,7],[4,5]];break;case 7:p2=[[6,8],[5,6]];break;case 8:p2=[[6,7]];break}aimin=cardhu.length;p3a=[];for(k=0;k<7;k++)p3a.push([k,k+1,k+2]);p3b=[];for(k=6;k>=0;k--)p3b.push([k,k+1,k+2]);for(m=0;m<p2.length;m++){clone=cardhu.slice(0);if(matchn(clone,p2[m])){dropMatch(clone,e.t,p2[m]);small=p2[m][0];big=p2[m][1];if(big>4)p3=p3a;else p3=p3b;for(j=0;j<p3.length;j++){if(p3==p3a)n=p3[j][0];else n=p3[j][2];if(matcht(clone,n)==3){dropMatch(clone,e.t,[n,n,n]);continue}for(k=0;k<4;k++){if(matchn(clone,p3[j]))dropMatch(clone,e.t,p3[j])}}for(j=0;j<9;j++){if(matcht(clone,j)==3)dropMatch(clone,e.t,[j,j,j]);else if(matcht(clone,j)==2)dropMatch(clone,e.t,[j,j])}found=false;for(j=0;j<clone.length;j++){if(e.n==clone[j].n){found=true;break}}if(!found&&aimin>clone.length){if(big==8||small==0){x=p2[m];aimin=clone.length}else if(big-small>1){if(matchn(clone,[small-1,small])&&small>1){x=p2[m];aimin=clone.length}else if(matchn(clone,[big,big+1])&&big<7){x=p2[m];aimin=clone.length}else{for(j=0;j<clone.length;j++){if(clone[j].n==big+1||clone[j].n==small-1){found=true;break}}if(!found){x=p2[m];aimin=clone.length}}}else{for(j=0;j<clone.length;j++){if(e.n<small&&clone[j].n==big+1){found=true;break}if(e.n>big&&clone[j].n==small-1){found=true;break}}if(!found){x=p2[m];aimin=clone.length}}}if(DeleteCard)delete clone}}if(DeletePat)delete p2;if(DeletePat)delete p3a;if(DeletePat)delete p3b}if(DeleteCard)delete cardhu}if(x!=null)x.push(e.n);return x}function cardeat2(e){var j,k,t,n;var p,cardhu;var cloneone,clonetwo;var x,aimin;var pattern=null;if(this.card.length>3&&e.t<3){cloneone=new Hucardclone(this);cardhu=cloneone.card;p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);for(t=0;t<3;t++){for(j=0;j<p.length;j++){n=p[j][0];if(matchtime(cardhu,t,n)==3){dropMatch(cardhu,t,[n,n,n]);continue}else if(matchtime(cardhu,t,n)==2){dropMatch(cardhu,t,[n,n]);continue}for(k=0;k<4;k++){if(patternMatch(cardhu,t,p[j]))dropMatch(cardhu,t,p[j])}}}x=[];cardhu.push(e);for(j=0;j<p.length;j++){if(patternMatch(cardhu,e.t,p[j])){pattern=p[j];x.push(p[j])}}if(pattern!=null){aimin=17;for(k=0;k<x.length;k++){clonetwo=new Hucardclone(this);clonetwo.card.push(e);dropMatch(clonetwo.card,e.t,x[k]);if(MJdebugEAT){}j=clonetwo.listdrop();if(j<aimin){pattern=x[k];aimin=j}clonetwo.dispose();delete clonetwo}if(MJdebugEAT){}}if(DeletePat)delete x;if(DeletePat)delete p;cloneone.dispose();delete cloneone}return pattern}function cardgung(e){var j,k,t;var p,cardhu;var found=false;if(this.card.length>3){cardhu=this.card.slice(0);p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);for(t=0;t<3;t++){for(j=0;j<p.length;j++){for(k=0;k<4;k++){if(patternMatch(cardhu,t,p[j]))dropMatch(cardhu,t,p[j])}}}if(DeletePat)delete p;if(e.t!=3||e.n<7){if(matchtime(cardhu,e.t,e.n)>=3)found=true}if(DeleteCard)delete cardhu}return found}function selfgung(e){var j,k,t;var p,cardhu,c;var found;if(this.card.length>3){cardhu=this.card.slice(0);found=false;p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);for(t=0;t<3;t++){for(j=0;j<p.length;j++){for(k=0;k<4;k++){if(patternMatch(cardhu,t,p[j]))dropMatch(cardhu,t,p[j])}}}if(DeletePat)delete p;cardhu.push(e);for(k=0;k<cardhu.length;k++){c=cardhu[k];if(c.t!=3||c.n<7){if(matchtime(cardhu,c.t,c.n)>=4){found=true;break}}else{showAlert("selfgung Card has some problem");break}}if(DeleteCard)delete cardhu;if(found)return c}return null}function deskgung(e){var cardhu;var status=false;if(this.desk.length>0){cardhu=this.desk;if(e.t!=3||e.n<7){if(matchtime(cardhu,e.t,e.n)>=3)status=true}else{showAlert("deskgung Card has some problem")}}return status}function cardpong2(e){var j,k,t;var p,cardhu;var status=false;if(this.card.length>3){cardhu=this.card.slice(0);p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);for(t=0;t<3;t++){for(j=0;j<p.length;j++){for(k=0;k<4;k++){if(patternMatch(cardhu,t,p[j]))dropMatch(cardhu,t,p[j])}}}if(DeletePat)delete p;if(e.t!=3||e.n<7){if(matchtime(cardhu,e.t,e.n)>=3)status=false;else if(matchtime(cardhu,e.t,e.n)==2)status=true}if(DeleteCard)delete cardhu}return status}function hulaDrop3(cardt,p){var j,k,t;for(t=0;t<3;t++){for(j=0;j<p.length;j++){for(k=0;k<4;k++){if(patternMatch(cardt,t,p[j]))dropMatch(cardt,t,p[j])}}}for(t=0;t<4;t++){for(j=0;j<9;j++){if(t!=3||j<7){if(matchtime(cardt,t,j)>=3)dropMatch(cardt,t,[j,j,j])}}}}function hulaDrop3B(cardt,p){var j,k,t;for(t=0;t<3;t++){for(j=0;j<p.length;j++){if(matchtime(cardt,t,p[j][0])==3)continue;for(k=0;k<4;k++){if(patternMatch(cardt,t,p[j]))dropMatch(cardt,t,p[j])}}}for(t=0;t<4;t++){for(j=0;j<9;j++){if(t!=3||j<7){if(matchtime(cardt,t,j)>=3)dropMatch(cardt,t,[j,j,j])}}}}function hulaDrop2(cardt){var j,t;for(t=0;t<4;t++){for(j=0;j<9;j++){if(t!=3||j<7){if(matchtime(cardt,t,j)>=2)dropMatch(cardt,t,[j,j])}}}}function cardhula(e){var t,j,k;var p,cardhu,clone2;var x,found;function hulaMatch(p){for(j=0;j<x.length;j++){clone2=cardhu.slice(0);dropMatch(clone2,x[j].t,[x[j].n,x[j].n]);hulaDrop3(clone2,p);if(clone2.length==0){found=true;break}if(clone2.length==3){for(k=0;k<3;k++){if(matchtime(clone2,clone2[k].t,clone2[k].n)>=2){dropMatch(clone2,clone2[k].t,[clone2[k].n,clone2[k].n]);if(clone2[0].t==x[j].t&&clone2[0].n==x[j].n)found=true;break}}}if(DeleteCard)delete clone2}}function hulaMatchB(p){for(j=0;j<x.length;j++){clone2=cardhu.slice(0);dropMatch(clone2,x[j].t,[x[j].n,x[j].n]);hulaDrop3B(clone2,p);if(clone2.length==0){found=true;break}if(clone2.length==3){for(k=0;k<3;k++){if(matchtime(clone2,clone2[k].t,clone2[k].n)>=2){dropMatch(clone2,clone2[k].t,[clone2[k].n,clone2[k].n]);if(clone2[0].t==x[j].t&&clone2[0].n==x[j].n)found=true;break}}}if(DeleteCard)delete clone2}}if(this.card.length>0){cardhu=this.card.slice(0);cardhu.push(e);x=[];for(j=0;j<cardhu.length;j++){if(matchtime(cardhu,cardhu[j].t,cardhu[j].n)>=2){found=false;for(k=0;k<x.length;k++){if(x[k].t==cardhu[j].t&&x[k].n==cardhu[j].n){found=true;break}}if(!found)x.push(cardhu[j])}}found=false;if(x.length>0){if(cardhu.length==2)found=true;else{p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);hulaMatch(p);if(!found)hulaMatchB(p);if(!found){if(DeletePat)delete p;p=[];for(k=6;k>=0;k--)p.push([k,k+1,k+2]);hulaMatch(p)}}}if(DeletePat)delete p;if(DeletePat)delete x;if(DeleteCard)delete cardhu}else showAlert("cardhula Card length=0");return found}function cardhulaAA(e){var t,j,k;var p,cardhu,clone2;var status,cardlen;var x;var p2,found;status=0;if(this.card.length>0){cardhu=this.card.slice(0);cardhu.push(e);x=[];for(j=0;j<cardhu.length;j++){if(matchtime(cardhu,cardhu[j].t,cardhu[j].n)>=2){found=false;for(k=0;k<x.length;k++){if(x[k].t==cardhu[j].t&&x[k].n==cardhu[j].n){found=true;break}}if(!found)x.push(cardhu[j])}}p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);if(x.length==0){hulaDrop3(cardhu,p);if(cardhu.length==2){status=2}if(DeletePat)delete p;if(DeleteCard)delete cardhu;return status}p2=[];for(k=0;k<7;k++){p2.push([k,k+1]);p2.push([k,k+2])}p2.push([7,8]);found=false;for(j=0;j<x.length;j++){clone2=cardhu.slice(0);dropMatch(clone2,x[j].t,[x[j].n,x[j].n]);hulaDrop3(clone2,p);cardlen=clone2.length;if(cardlen==0){status=1;found=true}else if(cardlen==3){for(k=0;k<3;k++){if(matchtime(clone2,clone2[k].t,clone2[k].n)>=2){if(x[j].t==clone2.t&&x[j].n==clone2.n)status=1;else status=3;found=true;break}}if(!found){for(t=0;t<3;t++){for(k=0;k<p2.length;k++){if(patternMatch(clone2,t,p2[k])){status=4;found=true;break}}if(found)break}}}if(DeleteCard)delete clone2;if(found)break}if(!found){if(DeletePat)delete p;p=[];for(k=6;k>=0;k--)p.push([k,k+1,k+2]);for(j=0;j<x.length;j++){clone2=cardhu.slice(0);dropMatch(clone2,x[j].t,[x[j].n,x[j].n]);hulaDrop3(clone2,p);cardlen=clone2.length;if(cardlen==0){status=1;found=true}else if(cardlen==3){for(k=0;k<3;k++){if(matchtime(clone2,clone2[k].t,clone2[k].n)>=2){if(x[j].t==clone2.t&&x[j].n==clone2.n)status=1;else status=3;found=true;break}}if(!found){for(t=0;t<3;t++){for(k=0;k<p2.length;k++){if(patternMatch(clone2,t,p2[k])){status=4;found=true;break}}if(found)break}}}if(DeleteCard)delete clone2;if(found)break}}if(false){if(status==0){if(DeletePat)delete p;p=[];for(k=6;k>=0;k--)p.push([k,k+1,k+2]);for(j=0;j<x.length;j++){clone2=cardhu.slice(0);dropMatch(clone2,x[j].t,[x[j].n,x[j].n]);hulaDrop3(clone2,p);cardlen=clone2.length;if(cardlen==0){status=1;found=true}else if(cardlen==3){hulaDrop2(clone2);cardlen=clone2.length;if(cardlen==1){status=3;found=true}else{for(t=0;t<3;t++){for(k=0;k<p2.length;k++){if(patternMatch(clone2,t,p2[k])){status=4;found=true;break}}if(found)break}}}if(DeleteCard)delete clone2}}}if(DeletePat)delete p;if(DeletePat)delete p2;if(DeletePat)delete x;if(DeleteCard)delete cardhu}else showAlert("cardhula Card length=0");return status}function cardhulaAAA(e){var t,j,k;var p,cardhu,clone2;var x,found;if(this.card.length>0){cardhu=this.card.slice(0);cardhu.push(e);x=[];for(j=0;j<cardhu.length;j++){if(matchtime(cardhu,cardhu[j].t,cardhu[j].n)>=2){found=false;for(k=0;k<x.length;k++){if(x[k].t==cardhu[j].t&&x[k].n==cardhu[j].n){found=true;break}}if(!found)x.push(cardhu[j])}}found=false;if(x.length>0){p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);function hulaMarch(p){for(j=0;j<x.length;j++){clone2=cardhu.slice(0);dropMatch(clone2,x[j].t,[x[j].n,x[j].n]);hulaDrop3(clone2,p);if(clone2.length==0){found=true;break}if(DeleteCard)delete clone2}}hulaMarch(p);if(!found){if(DeletePat)delete p;p=[];for(k=6;k>=0;k--)p.push([k,k+1,k+2]);hulaMarch(p)}}if(DeletePat)delete p;if(DeletePat)delete x;if(false){if(status!=1){p=[];for(k=0;k<7;k++)p.push([k,k+1,k+2]);hulaDrop3(cardhu,p);if(DeletePat)delete p;if(cardhu.length==2){if(cardhu[0].t==cardhu[1].t&&cardhu[0].n==cardhu[1].n){status=1}else{status=2;clone2=this.card.slice(0);clone2.push(e);p=[];for(k=6;k>=0;k--)p.push([k,k+1,k+2]);hulaDrop3(clone2,p);if(clone2.length==2){if(clone2[0].t==clone2[1].t&&clone2[0].n==clone2[1].n){status=1}}if(DeletePat)delete p;if(DeleteCard)delete clone2}}else if(cardhu.length==5){clone2=this.card.slice(0);clone2.push(e);p=[];for(k=6;k>=0;k--)p.push([k,k+1,k+2]);hulaDrop3(clone2,p);if(clone2.length==2){if(clone2[0].t==clone2[1].t&&clone2[0].n==clone2[1].n){status=1}}if(DeletePat)delete p;if(DeleteCard)delete clone2;if(status!=1){hulaDrop2(cardhu);if(cardhu.length==1){status=3}else if(cardhu.length==3){p=[];for(k=0;k<7;k++){p.push([k,k+1]);p.push([k,k+2])}p.push([7,8]);for(t=0;t<3;t++){for(j=0;j<p.length;j++){if(patternMatch(cardhu,t,p[j]))dropMatch(cardhu,t,p[j])}}if(cardhu.length==1)status=4;if(DeletePat)delete p}}}}}if(DeleteCard)delete cardhu}else showAlert("cardhula Card length=0");return found}function Hucardclone(player){this.card=player.card.slice(0);this.name=player.name+"選牌:";this.dispose=function(){delete this.card;delete this.name;this.card=null;this.name=null}}Hucardclone.prototype.sortmj=function(){cardsort.call(this)};Hucardclone.prototype.swap=function(i,j){cardswap.call(this,i,j)};Hucardclone.prototype.dump=function(){carddump.call(this)};Hucardclone.prototype.listdrop=function(){return listdrop.call(this)};Hucardclone.prototype.listendrop=function(){return listendrop.call(this)};function gungStation(resetgung){var index;var temp;var cardlen;if(arguments.length>=1){if(resetgung){this.gungOrder=0;this.gungTime=0}}else{this.gungTime++;if(this.gungOrder==0)this.gungOrder=1;else this.gungOrder=0;temp=this.card[this.gungOrder];cardlen=this.card.length;for(index=this.gungOrder;index<cardlen-1;index++)this.card[index]=this.card[index+1];this.card[cardlen-1]=temp}}function isGameOver(num){if(this.card.length<=num+this.gungTime)return true;else return false}function pinghu(e){var j,k,t,c;var cardhu,deskhu;var p,pat;var status,found;var cardlen;if(this.desk.length==0)return false;cardhu=this.card.slice(0);deskhu=this.desk;for(j=0;j<deskhu.length;j++){cardhu.push(deskhu[j])}if(cardhu.length>=17){status=true;for(j=0;j<cardhu.length;j++){if(cardhu[j].t==3){status=false;break}if(matchtime(cardhu,cardhu[j].t,cardhu[j].n)>=3){status=false;break}}cardlen=cardhu.length;found=false;for(j=0;j<cardlen;j++){c=cardhu[j];if(e.t==c.t&&e.n==c.n){if(j!=cardlen-1){cardhu[j]=cardhu[cardlen-1];cardhu[cardlen-1]=c}cardhu.pop();found=true;break}}if(found){if(status){p=[];for(j=0;j<7;j++)p.push([j,j+1,j+2]);for(t=0;t<3;t++){for(j=0;j<p.length;j++){for(k=0;k<4;k++){if(patternMatch(cardhu,t,p[j]))dropMatch(cardhu,t,p[j])}}}if(DeletePat)delete p;if(cardhu.length==1)status=false;else if(cardhu.length==4){for(j=0;j<cardhu.length;j++){if(matchtime(cardhu,cardhu[j].t,cardhu[j].n)>=2){dropMatch(cardhu,cardhu[j].t,[cardhu[j].n,cardhu[j].n]);break}}if(cardhu.length!=2)status=false;else{if(cardhu[0].n>cardhu[1].n)j=cardhu[0].n-cardhu[1].n;else j=cardhu[1].n-cardhu[0].n;if(j!=1)status=false;else if(cardhu[0].n==0||cardhu[0].n==8||cardhu[1].n==0||cardhu[1].n==8)status=false}}else status=false}}else{status=false;showAlert("pinghu cardhu not found e")}}else{status=false;showAlert("pinghu card length <17")}if(DeleteCard)delete cardhu;return status}function big4lucky(e){var pat,j;var status,found;var cardhu,deskhu;cardhu=this.card.slice(0);deskhu=this.desk;for(j=0;j<deskhu.length;j++){cardhu.push(deskhu[j])}status=false;if(cardhu.length>=17){found=false;for(j=0;j<cardhu.length;j++){if(e.t==cardhu[j].t&&e.n==cardhu[j].n){found=true;break}}if(found){pat=[0,0,0,1,1,1,2,2,2,3,3,3];if(patternMatch(cardhu,3,pat))status=true;if(DeletePat)delete pat}else showAlert("big4lucky card not found e")}else showAlert("big4lucky card length <17");if(DeleteCard)delete cardhu;return status}function small4lucky(e){var j,pp;var status,found;var cardhu,deskhu;cardhu=this.card.slice(0);deskhu=this.desk;for(j=0;j<deskhu.length;j++){cardhu.push(deskhu[j])}status=false;if(cardhu.length>=17){found=false;for(j=0;j<cardhu.length;j++){if(e.t==cardhu[j].t&&e.n==cardhu[j].n){found=true;break}}if(found){pp=[[0,0,1,1,1,2,2,2,3,3,3],[0,0,0,1,1,2,2,2,3,3,3],[0,0,0,1,1,1,2,2,3,3,3],[0,0,0,1,1,1,2,2,2,3,3]];for(j=0;j<pp.length;j++){if(patternMatch(cardhu,3,pp[j])){status=true;break}}if(DeletePat)delete pp}else showAlert("small4lucky card not found e")}else showAlert("small4lucky card length <17");if(DeleteCard)delete cardhu;return status}function big3element(e){var pat,j;var status,found;var cardhu,deskhu;cardhu=this.card.slice(0);deskhu=this.desk;for(j=0;j<deskhu.length;j++){cardhu.push(deskhu[j])}status=false;if(cardhu.length>=17){found=false;for(j=0;j<cardhu.length;j++){if(e.t==cardhu[j].t&&e.n==cardhu[j].n){found=true;break}}if(found){pat=[4,4,4,5,5,5,6,6,6];if(patternMatch(cardhu,3,pat))status=true;if(DeletePat)delete pat}else showAlert("big3element card not found e")}else showAlert("big3element card length <17");if(DeleteCard)delete cardhu;return status}function small3element(e){var j,pp;var status,found;var cardhu,deskhu;cardhu=this.card.slice(0);deskhu=this.desk;for(j=0;j<deskhu.length;j++){cardhu.push(deskhu[j])}status=false;if(cardhu.length>=17){found=false;for(j=0;j<cardhu.length;j++){if(e.t==cardhu[j].t&&e.n==cardhu[j].n){found=true;break}}if(found){pp=[[4,4,5,5,5,6,6,6],[4,4,4,5,5,6,6,6],[4,4,4,5,5,5,6,6]];for(j=0;j<pp.length;j++){if(patternMatch(cardhu,3,pp[j])){status=true;break}}if(DeletePat)delete pp}else showAlert("small3element card not found e")}else showAlert("small3element card length <17");if(DeleteCard)delete cardhu;return status}function samedecal0(e){var j,t;var status,found;var cardhu,deskhu;cardhu=this.card.slice(0);deskhu=this.desk;for(j=0;j<deskhu.length;j++){cardhu.push(deskhu[j])}if(cardhu.length>=17){status=true;found=false;for(j=0;j<cardhu.length;j++){if(e.t==cardhu[j].t&&e.n==cardhu[j].n){found=true;break}}if(found){t=cardhu[0].t;for(j=1;j<cardhu.length;j++){if(t!=cardhu[j].t){status=false;break}}}else showAlert("samedecal0 card not found e")}else{status=false;showAlert("samedecal0 card length <17")}if(DeleteCard)delete cardhu;return status}function samedecal(e){var j,t;var decal,word;var found;var cardhu,deskhu;cardhu=this.card.slice(0);deskhu=this.desk;for(j=0;j<deskhu.length;j++){cardhu.push(deskhu[j])}decal=0;word=false;if(cardhu.length>=17){found=false;for(j=0;j<cardhu.length;j++){if(e.t==cardhu[j].t&&e.n==cardhu[j].n){found=true;break}}if(found){for(j=0;j<cardhu.length;j++){if(cardhu[j].t==3){word=true;continue}t=cardhu[j].t;decal++}if(decal>0){for(j=0;j<cardhu.length;j++){if(cardhu[j].t==3)continue;if(t!=cardhu[j].t){decal=-1;break}}}}else showAlert("samedecal card not found e")}else showAlert("samedecal card length <17");if(DeleteCard)delete cardhu;if(!word&&decal>0)return 4;else if(word&&decal==0)return 2;else if(word&&decal>0)return 1;else return 0}function ponghu(e){var j,t,c;var cardlen;var status,found;var cardhu,deskhu;cardhu=this.card.slice(0);deskhu=this.desk;for(j=0;j<deskhu.length;j++){cardhu.push(deskhu[j])}status=false;if(cardhu.length>=17){cardlen=cardhu.length;found=false;for(j=0;j<cardlen;j++){c=cardhu[j];if(e.t==c.t&&e.n==c.n){if(j!=cardlen-1){cardhu[j]=cardhu[cardlen-1];cardhu[cardlen-1]=c}found=true;cardhu.pop();break}}if(found){for(t=0;t<4;t++){for(j=0;j<9;j++){if(t!=3||j<7){if(matchtime(cardhu,t,j)>=4)dropMatch(cardhu,t,[j,j,j,j]);else if(matchtime(cardhu,t,j)>=3)dropMatch(cardhu,t,[j,j,j])}}}if(cardhu.length==1){if(e.t==cardhu[0].t&&e.n==cardhu[0].n)status=true}else if(cardhu.length==4){if(matchtime(cardhu,e.t,e.n)>=2)dropMatch(cardhu,e.t,[e.n,e.n]);if(cardhu.length==2){if(cardhu[0].t==cardhu[1].t&&cardhu[0].n==cardhu[1].n)status=true}}}else showAlert("ponghu card not found e")}else showAlert("samedecal card length <17");if(DeleteCard)delete cardhu;return status}function dark345(e,gamehu){var t,j,k;var count,found;var cardhu;var p;if(arguments.length<2)gamehu=false;cardhu=this.card.slice(0);for(j=0;j<this.desk.length;j++){if(this.desk[j].markdown){cardhu.push(this.desk[j])}}count=0;found=false;for(j=0;j<cardhu.length;j++){if(e.t==cardhu[j].t&&e.n==cardhu[j].n){found=true;break}}if(found){p=[];for(j=0;j<7;j++)p.push([j,j+1,j+2]);for(t=0;t<3;t++){for(j=0;j<p.length;j++){
for(k=0;k<4;k++){if(patternMatch(cardhu,t,p[j]))dropMatch(cardhu,t,p[j])}}}for(t=0;t<4;t++){for(j=0;j<9;j++){if(t!=3||j<7){if(gamehu&&e.t==t&&e.n==j)continue;if(matchtime(cardhu,t,j)>=3)count++}}}}else showAlert("dark345 card not found e");if(DeleteCard)delete cardhu;return count}function desknoteat(e){var j;var status,found;var cardhu;cardhu=this.card.slice(0);found=false;for(j=0;j<cardhu.length;j++){if(e.t==cardhu[j].t&&e.n==cardhu[j].n){found=true;break}}if(found){status=true;if(this.desk.length>0){for(j=0;j<this.desk.length;j++){if(!this.desk[j].markdown){status=false;break}}}}else{status=false;showAlert("desknoteat card not found e")}if(DeleteCard)delete cardhu;return status}function word3(e){var j;var count,found;var cardhu;cardhu=this.card.slice(0);for(j=0;j<this.desk.length;j++){cardhu.push(this.desk[j])}count=0;if(cardhu.length>=17){found=false;for(j=0;j<cardhu.length;j++){if(e.t==cardhu[j].t&&e.n==cardhu[j].n){found=true;break}}if(found){for(j=0;j<7;j++){if(matchtime(cardhu,3,j)>=3)count++}}else showAlert("word3 card not found e")}else showAlert("word3 card length <17");if(DeleteCard)delete cardhu;return count}function mjTest(cardstation,play,wishmj){var j,k,m;var findlast,wishlast,lastone;var found;var ecard;var wish,textstr;var n,t,i;if(arguments.length>2){wish=[];for(j=0,m=0;j<wishmj.length;j++){textstr=wishmj[j];found=false;for(k=0;k<7;k++){if(textstr.charAt(0)==Mjword[k]){t=3;n=k;i=0;found=true;break}}if(!found){for(k=0;k<3;k++){if(textstr.charAt(1)==Mjtype[k]){t=k;i=0;n=0;while(n<9){if(Mjnum[n]==textstr.charAt(0)){found=true;break}n++}break}}}if(found){for(k=0;k<wish.length;k++){if(wish[k].t==t&&wish[k].n==n)i++}wish[m++]=new onemj(n,t,i)}}if(wish.length==17){lastone=play[0].card.length-1;wishlast=wish.length-1;for(j=0;j<wish.length;j++){found=false;if(j!=wishlast){findlast=lastone;for(k=0;k<play[0].card.length;k++){if(play[0].card[k].t==wish[j].t&&play[0].card[k].n==wish[j].n&&play[0].card[k].i==wish[j].i){if(k!=findlast)play[0].swap(k,findlast);found=true;break}}}if(!found){findlast=cardstation.card.length-1;for(k=0;k<cardstation.card.length;k++){if(cardstation.card[k].t==wish[j].t&&cardstation.card[k].n==wish[j].n&&cardstation.card[k].i==wish[j].i){if(k!=findlast)cardstation.swap(k,findlast);if(j!=wishlast){ecard=cardstation.card.pop();cardstation.card.push(play[0].card.pop());play[0].card.push(ecard)}found=true;break}}}if(!found){for(m=1;m<4;m++){findlast=play[m].card.length-1;for(k=0;k<play[m].card.length;k++){if(play[m].card[k].t==wish[j].t&&play[m].card[k].n==wish[j].n&&play[m].card[k].i==wish[j].i){if(k!=findlast)play[m].swap(k,findlast);ecard=play[m].card.pop();if(j!=wishlast){play[m].card.push(play[0].card.pop());play[0].card.push(ecard)}else{play[m].card.push(cardstation.card.pop());cardstation.card.push(ecard)}found=true;break}}if(found)break}}if(j!=wishlast&&j!=lastone)play[0].swap(j,lastone)}for(j=0;j<4;j++)play[j].dump(0);cardstation.dump(1);for(j=0;j<cardstation.card.length;j++)cardstation.card[j].mesh.setEnabled(1)}else showAlert("length != 17")}else showAlert("Usage: MJTest(cardstation, play, MJmatrix)    Mjmatrix.length should be 17")}function point3D(x,y,z){return new BABYLON.Vector3(x,y,z)}function origin(){return new BABYLON.Vector3(0,0,0)}function move3D(x,y,z){if(arguments.length>0)this.position.x=x;if(arguments.length>1)this.position.y=y;if(arguments.length>2)this.position.z=z}function move3Dx(d){if(arguments.length>0)this.position.x=d}function move3Dy(d){if(arguments.length>0)this.position.y=d}function move3Dz(d){if(arguments.length>0)this.position.z=d}function forward3D(dx,dy,dz){if(arguments.length>0)this.position.x+=dx;if(arguments.length>1)this.position.y+=dy;if(arguments.length>2)this.position.z+=dz}function forward3Dx(d){if(arguments.length>0)this.position.x+=d}function forward3Dy(d){if(arguments.length>0)this.position.y+=d}function forward3Dz(d){if(arguments.length>0)this.position.z+=d}function backward3D(dx,dy,dz){if(arguments.length>0)this.position.x-=dx;if(arguments.length>1)this.position.y-=dy;if(arguments.length>2)this.position.z-=dz}function backward3Dx(d){if(arguments.length>0)this.position.x-=d}function backward3Dy(d){if(arguments.length>0)this.position.y-=d}function backward3Dz(d){if(arguments.length>0)this.position.z-=d}function rotate3Dr(xr,yr,zr){if(arguments.length>0)this.rotation.x=xr;if(arguments.length>1)this.rotation.y=yr;if(arguments.length>2)this.rotation.z=zr}function rotate3Drx(r){if(arguments.length>0)this.rotation.x=r}function rotate3Dry(r){if(arguments.length>0)this.rotation.y=r}function rotate3Drz(r){if(arguments.length>0)this.rotation.z=r}function rotate3D(x,y,z){if(arguments.length>0)this.rotation.x=x*Math.PI/180;if(arguments.length>1)this.rotation.y=y*Math.PI/180;if(arguments.length>2)this.rotation.z=z*Math.PI/180}function rotate3Dx(d){if(arguments.length>0)this.rotation.x=d*Math.PI/180}function rotate3Dy(d){if(arguments.length>0)this.rotation.y=d*Math.PI/180}function rotate3Dz(d){if(arguments.length>0)this.rotation.z=d*Math.PI/180}function scale3D(sx,sy,sz){if(arguments.length>0)this.scaling.x=sx;if(arguments.length>1)this.scaling.y=sy;if(arguments.length>2)this.scaling.z=sz}function scale3Dx(s){if(arguments.length>0)this.scaling.x=s}function scale3Dy(s){if(arguments.length>0)this.scaling.y=s}function scale3Dz(s){if(arguments.length>0)this.scaling.z=s}function parent(parent){this.parent=parent}function color3(r,g,b){if(arguments.length>0)return new BABYLON.Color3(r,g,b)}function globalObjAddname(){var aname;sn=globalObj.listname.length;aname=globalObj.basename+sn;globalObj.listname.push(aname);return aname}function newMaterial(){var aname;aname=globalObjAddname();return new BABYLON.StandardMaterial(aname,globalObj.scene)}function newText(textstr){var aname;aname=globalObjAddname();textTexture=new BABYLON.DynamicTexture(aname,64,globalObj.scene,true);for(i=0;i<textstr.length;i++){textTexture.drawText(textstr.charAt(i),0,24+i*24,"normal 24px Arial","red","transparent",true)}return textTexture}function genGround(height,width,devide){var aname;if(arguments.length<3)devide=12;if(arguments.length<2)width=10;if(arguments.length<1)height=10;aname=globalObjAddname();return BABYLON.Mesh.CreateGround(aname,height,width,devide,globalObj.scene)}function genSphere(size,seg){var aname;if(arguments.length<2)seg=12;if(arguments.length<1)size=1;aname=globalObjAddname();return BABYLON.Mesh.CreateSphere(aname,seg,size,globalObj.scene)}function genBox(size){var aname;if(arguments.length<1)size=1;aname=globalObjAddname();return BABYLON.Mesh.CreateBox(aname,size,globalObj.scene)}function genPlane(size){var aname;if(arguments.length<1)size=1;aname=globalObjAddname();return BABYLON.Mesh.CreatePlane(aname,size,globalObj.scene)}function genDisc(size,seg){var aname;if(arguments.length<2)seg=12;if(arguments.length<1)size=1;aname=globalObjAddname();return BABYLON.Mesh.CreateDisc(aname,size,seg,globalObj.scene,false,BABYLON.Mesh.DOUBLESIDE)}function genCylinder(height,top,bottom,seg,heightseg){var aname;if(arguments.length<5)heightseg=13;if(arguments.length<4)seg=12;if(arguments.length<3)bottom=1;if(arguments.length<2)top=1;if(arguments.length<1)height=1;aname=globalObjAddname();return BABYLON.Mesh.CreateCylinder(aname,height,top,bottom,seg,heightseg,globalObj.scene)}function genTorus(diameter,thickness,seg){var aname;if(arguments.length<3)seg=12;if(arguments.length<2)thickness=1;if(arguments.length<1)diameter=1;aname=globalObjAddname();return BABYLON.Mesh.CreateTorus(aname,diameter,thickness,seg,globalObj.scene)}function genLines(points){var aname;var pointmatrix;if(arguments.length<1)pointmatrix=[origin(),origin()];else{if(points.length>1)pointmatrix=points;else{if(points.length==1)pointmatrix=[origin(),points[0]];else pointmatrix=[origin(),origin()]}}aname=globalObjAddname();return BABYLON.Mesh.CreateLines(aname,pointmatrix,globalObj.scene)}function keyupSet(key,callback){if(globalObj.keyboard==null){globalObj.scene.actionManager=new BABYLON.ActionManager(globalObj.scene);globalObj.keyboard=globalObj.scene.actionManager}globalObj.keyboard.registerAction(new BABYLON.ExecuteCodeAction({trigger:BABYLON.ActionManager.OnKeyUpTrigger,parameter:key},callback))}function keydownSet(key,callback){if(globalObj.keyboard==null){globalObj.scene.actionManager=new BABYLON.ActionManager(globalObj.scene);globalObj.keyboard=globalObj.scene.actionManager}globalObj.keyboard.registerAction(new BABYLON.ExecuteCodeAction({trigger:BABYLON.ActionManager.OnKeyDownTrigger,parameter:key},callback))}function mouseover(callback){if(typeof this!=="undefined"){if(this.actionManager==null)this.actionManager=new BABYLON.ActionManager(globalObj.scene);this.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger,callback))}}function mouseout(callback){if(typeof this!=="undefined"){if(this.actionManager==null)this.actionManager=new BABYLON.ActionManager(globalObj.scene);this.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger,callback))}}function leftpick(callback){if(typeof this!=="undefined"){if(this.actionManager==null)this.actionManager=new BABYLON.ActionManager(globalObj.scene);this.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnLeftPickTrigger,callback))}}function centerpick(callback){if(typeof this!=="undefined"){if(this.actionManager==null)this.actionManager=new BABYLON.ActionManager(globalObj.scene);this.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnCenterPickTrigger,callback))}}function rightpick(callback){if(typeof this!=="undefined"){if(this.actionManager==null)this.actionManager=new BABYLON.ActionManager(globalObj.scene);this.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnRightPickTrigger,callback))}}function pickup(callback){if(typeof this!=="undefined"){if(typeof this.actionManager==="undefined")this.actionManager=new BABYLON.ActionManager(globalObj.scene);this.actionManager.registerAction(new BABYLON.ExecuteCodeAction({trigger:BABYLON.ActionManager.OnPickUpTrigger,parameter:"x"},function(){callback()}))}}function touchdown(callback){if(typeof this!=="undefined"){if(typeof this.actionManager==="undefined")this.actionManager=new BABYLON.ActionManager(globalObj.scene);this.actionManager.registerAction(new BABYLON.ExecuteCodeAction({trigger:BABYLON.ActionManager.OnPickTrigger,parameter:"x"},function(){callback()}))}}function putdown(callback){if(typeof this!=="undefined"){if(typeof this.actionManager==="undefined")this.actionManager=new BABYLON.ActionManager(globalObj.scene);this.actionManager.registerAction(new BABYLON.ExecuteCodeAction({trigger:BABYLON.ActionManager.OnPickOutTrigger,parameter:"x"},function(){callback()}))}}function keyFrame(fps,val){this.push({frame:fps,value:val})}function genFocus(size){var aname;if(typeof mousewall==="undefined"){if(arguments.length<1)size=1;aname=globalObjAddname();mousewall=genPlane(size);mousewall.material=new BABYLON.StandardMaterial(aname,globalObj.scene);mousewall.material.alpha=.5}return mousewall}function genImpact(size){var aname;if(arguments.length<1)size=1;impactwall=genPlane(size);aname=globalObjAddname();impactwall.material=new BABYLON.StandardMaterial(aname,globalObj.scene);impactwall.material.diffuseTexture=new BABYLON.Texture("impact.png",globalObj.scene);return impactwall}function walk(property,valstart,valend,fps,total){var aname;if(arguments.length<5)var fps=10;if(arguments.length<4)var total=10;aname=globalObjAddname();BABYLON.Animation.CreateAndStartAnimation(aname,this,property,fps,total,valstart,valend)}function putlight(x,y,z){globalObj.putlight(x,y,z)}function genGlobal(scene,camera,light){this.basename="mybaby";this.listname=[];this.camera=camera;this.scene=scene;this.light=light;this.position=point3D(0,0,0);this.putlight=function(x,y,z){this.light.setDirectionToTarget(point3D(x,y,z))}}function debugon(){globalObj.scene.debugLayer.show(true,globalObj.camera)}function genBaby(canvasId){window.addEventListener("DOMContentLoaded",function(){var canvas=document.getElementById(canvasId);var engine=new BABYLON.Engine(canvas,true);var scene=new BABYLON.Scene(engine);var camera=new BABYLON.ArcRotateCamera("myCamera",Math.PI*3/2,1,16,origin(),scene);var lightbk=new BABYLON.HemisphericLight("myLight",point3D(-30,0,30),scene);var light=new BABYLON.HemisphericLight("bkLight",point3D(30,0,-30),scene);camera.attachControl(canvas,false);camera.inertia=0;move3D.call(camera,0,5,-20);globalObj=new genGlobal(scene,camera,light);mygame(scene,camera,light);engine.runRenderLoop(function(){scene.render()});window.addEventListener("resize",function(){engine.resize()})})}function loadBlender(babylonfile){BABYLON.SceneLoader.ImportMesh("","",babylonfile,globalObj.scene,function(newMeshes){})}function baby0Loader(canvasId,babylonfile){window.addEventListener("DOMContentLoaded",function(){var canvas=document.getElementById(canvasId);var engine=new BABYLON.Engine(canvas,true);var scene=new BABYLON.Scene(engine);var camera=new BABYLON.ArcRotateCamera("myCamera",Math.PI*3/2,1,10,origin(),scene);var light=new BABYLON.HemisphericLight("myLight",point3D(0,1,-10),scene);camera.attachControl(canvas,false);move3D.call(camera,0,1,-10);globalObj=new genGlobal(scene,camera,light);loadBlender(babylonfile);mygame(scene,camera,light);engine.runRenderLoop(function(){scene.render()});window.addEventListener("resize",function(){engine.resize()})})}function babyLoader(canvasId,babylonfile){if(!BABYLON.Engine.isSupported())return;var canvas=document.getElementById(canvasId);var engine=new BABYLON.Engine(canvas,true);BABYLON.SceneLoader.Load("",babylonfile,engine,SceneLoader,Proress);function Proress(proress){}function SceneLoader(blenderScene){blenderScene.executeWhenReady(sceneReady);function sceneReady(){var i;for(i=0;i<blenderScene.lights.length;i++){if(blenderScene.lights[i].name=="Lamp")blenderScene.removeLight(blenderScene.lights[i])}for(i=0;i<blenderScene.cameras.length;i++){if(blenderScene.cameras[i].name=="Camera")blenderScene.removeCamera(blenderScene.cameras[i])}var camera=new BABYLON.ArcRotateCamera("myCamera",Math.PI*3/2,1,10,origin(),blenderScene);var light=new BABYLON.HemisphericLight("myLight",point3D(1,0,0),blenderScene);camera.attachControl(canvas,true);Sphere2=null;Cube2=null;for(i=0;i<blenderScene.meshes.length;i++){if(blenderScene.meshes[i].name=="Sphere")Sphere2=blenderScene.meshes[i];if(blenderScene.meshes[i].name=="Cube")Cube2=blenderScene.meshes[i]}globalObj=new genGlobal(blenderScene,camera,light);if(Sphere2!=null)move3D.call(Sphere2,-2,1,-1);if(Cube2!=null)move3D.call(Cube2,2,1,-1);mygame(blenderScene,camera);engine.runRenderLoop(function(){blenderScene.render()})}}}function newTextMaterial(t,n,i,colr){var aname,textstr;var material;var fontsize,fontyoff,fontpix,fontxoff,pixstring;fontsize=48;fontyoff=12;fontpix=2*fontsize+fontyoff;fontxoff=fontsize*2/3+fontyoff/2;if(t<3)textstr=Mjnum[n]+Mjtype[t];else if(n<7){textstr=Mjword[n];fontyoff+=fontsize/2}else if(n==8)textstr=Mjseason[i]+Mjword[n];else if(i==2)textstr=Mjflower[i]+"子";else if(n==7)textstr=Mjflower[i]+Mjword[n];else{alert("newTextMaterial input wrong");textstr=""}aname=globalObjAddname();material=new BABYLON.StandardMaterial(aname,globalObj.scene);pixstring="normal "+fontsize+"px Arial";material.diffuseTexture=new BABYLON.DynamicTexture(aname,fontpix,globalObj.scene,true);if(arguments.length<4)colr="red";for(i=0;i<textstr.length;i++){fontyoff+=fontsize;material.diffuseTexture.drawText(textstr.charAt(i),fontxoff,fontyoff,pixstring,colr,"transparent",true)}material.diffuseColor=new BABYLON.Color3(1,1,1);return material}function newBoardtext(textstr){var aname;var i,colx,fontpix,fontsize,spacing,num,x,y;var pixstring,c,len;fontpix=512;fontsize=36;spacing=4;len=fontsize+spacing;pixstring="normal "+fontsize+"px Arial";aname=globalObjAddname();textTexture=new BABYLON.DynamicTexture(aname,fontpix,globalObj.scene,true);num=Math.floor(fontpix/len);y=len;for(i=0,colx=0,x=0;i<textstr.length;i++){c=textstr.charAt(i);if(c=="\n"){colx=0;x=0;y=y+len;continue}colx++;if(colx==num){colx=0;x=0;y=y+len}textTexture.drawText(c,x,y,pixstring,"red","transparent",true);x=x+len}return textTexture}function BlackBoardDraw(textstr){var aname;var i,colx,fontpix,fontsize,spacing,num,x,y;var pixstring,c,len;var textTexture;fontpix=512;if(typeof Gameblackboard=="undefined"){Gameblackboard=genGround(8,4,12);move3D.call(Gameblackboard,-12,2,8);rotate3Dx.call(Gameblackboard,300);Gameblackboard.material=newMaterial();aname=globalObjAddname();textTexture=new BABYLON.DynamicTexture(aname,fontpix,globalObj.scene,true);Gameblackboard.material.diffuseTexture=textTexture}textTexture=Gameblackboard.material.diffuseTexture;fontsize=36;spacing=4;len=fontsize+spacing;pixstring="normal "+fontsize+"px Arial";textTexture.drawText("",0,0,pixstring,"black","black",true);num=Math.floor(fontpix/len);y=len;for(i=0,colx=0,x=0;i<textstr.length;i++){c=textstr.charAt(i);if(c=="\n"){colx=0;x=0;y=y+len;continue}colx++;if(colx==num){colx=0;x=0;y=y+len}textTexture.drawText(c,x,y,pixstring,"white","transparent",true);x=x+len}}function FuncBoardDraw(textstr){var aname;var i,colx,fontpix,fontsize,spacing,num,x,y;var pixstring,c,len;var textTexture;fontpix=512;if(typeof FuncBoard=="undefined"){FuncBoard=genGround(8,4,12);move3D.call(FuncBoard,12,2,8);rotate3Dx.call(FuncBoard,300);FuncBoard.material=newMaterial();aname=globalObjAddname();textTexture=new BABYLON.DynamicTexture(aname,fontpix,globalObj.scene,true);FuncBoard.material.diffuseTexture=textTexture}textTexture=FuncBoard.material.diffuseTexture;fontsize=36;spacing=4;len=fontsize+spacing;pixstring="normal "+fontsize+"px Arial";textTexture.drawText("",0,0,pixstring,"black","black",true);num=Math.floor(fontpix/len);y=len;for(i=0,colx=0,x=0;i<textstr.length;i++){c=textstr.charAt(i);if(c=="\n"){colx=0;x=0;y=y+len;continue}colx++;if(colx==num){colx=0;x=0;y=y+len}textTexture.drawText(c,x,y,pixstring,"red","transparent",true);x=x+len}}function newMusic(filename){return new BABYLON.Sound(globalObjAddname(),filename,globalObj.scene)}BABYLON.Mesh.prototype.move=function(x,y,z){move3D.call(this,x,y,z)};BABYLON.Mesh.prototype.movex=function(d){move3Dx.call(this,d)};BABYLON.Mesh.prototype.movey=function(d){move3Dy.call(this,d)};BABYLON.Mesh.prototype.movez=function(d){move3Dz.call(this,d)};BABYLON.Mesh.prototype.rotate=function(xd,yd,zd){rotate3D.call(this,xd,yd,zd)};BABYLON.Mesh.prototype.rotatex=function(d){rotate3Dx.call(this,d)};BABYLON.Mesh.prototype.rotatey=function(d){rotate3Dy.call(this,d)};BABYLON.Mesh.prototype.rotatez=function(d){rotate3Dz.call(this,d)};BABYLON.Mesh.prototype.scale=function(sx,sy,sz){scale3D.call(this,sx,sy,sz)};BABYLON.Mesh.prototype.scalex=function(s){scale3Dx.call(this,s)};BABYLON.Mesh.prototype.scaley=function(s){scale3Dy.call(this,s)};BABYLON.Mesh.prototype.scalez=function(s){scale3Dz.call(this,s)};BABYLON.Mesh.prototype.forward=function(dx,dy,dz){forward3D.call(this,dx,dy,dz)};BABYLON.Mesh.prototype.forwardx=function(d){forward3Dx.call(this,d)};BABYLON.Mesh.prototype.forwardy=function(d){forward3Dy.call(this,d)};BABYLON.Mesh.prototype.forwardz=function(d){forward3Dz.call(this,d)};BABYLON.Mesh.prototype.backward=function(dx,dy,dz){backward3D.call(this,dx,dy,dz)};BABYLON.Mesh.prototype.backwardx=function(d){backward3Dx.call(this,d)};BABYLON.Mesh.prototype.backwardy=function(d){backward3Dy.call(this,d)};BABYLON.Mesh.prototype.backwardz=function(d){backward3Dz.call(this,d)};Copyright="Copyright (c) masong3000@gmail.com  All rights reserved";function autoplayClick(){if(this.autoplay){this.autoplay=false;BlackBoardDraw("解除鎖定使用者自行打牌")}else{this.autoplay=true;BlackBoardDraw("打牌鎖定讓電腦自動打牌")}}function autoeatClick(){if(this.autoeat){this.autoeat=false;BlackBoardDraw("解除,使用者決定吃碰牌")}else{this.autoeat=true;BlackBoardDraw("鎖定,讓電腦自動吃碰牌")}}function meshScale(sx,sy,sz){scale3D.call(this,sx,sy,sz)}function meshClick(c){var j;for(j=0;j<this.card.length;j++){if(this.card[j].t==c.t&&this.card[j].n==c.n){if(j!=this.card.length-1)this.swap(j,this.card.length-1);break}}ClickOneCard=c}function RegisterMouseOver(user){var j;var c;for(j=0;j<user.card.length;j++){c=user.card[j];leftpick.call(c.mesh,meshClick.bind(user,c))}ClickCardRegister=true}function UnregisterMouseOver(user){var j;var c;for(j=0;j<user.card.length;j++){c=user.card[j];c.mesh.actionManager.dispose();c.mesh.actionManager=null}ClickCardRegister=false;ClickOneCard=null}function ClickAccept(){ClickOneCard=true}function ClickCancel(){ClickOneCard=false}function RegisterButton(act){ClickCardRegister=true;leftpick.call(this.accept,ClickAccept);leftpick.call(this.cancel,ClickCancel);this.accept.material.diffuseTexture.drawText("",0,0,"normal 48px Arial","red","black","black",true);this.cancel.material.diffuseTexture.drawText("",0,0,"normal 48px Arial","red","black","black",true);this.accept.material.diffuseTexture.drawText(act,40,80,"normal 48px Arial","red","transparent",true);this.cancel.material.diffuseTexture.drawText("取",10,80,"normal 48px Arial","red","transparent",true);this.cancel.material.diffuseTexture.drawText("消",70,80,"normal 48px Arial","red","transparent",true);this.accept.setEnabled(1);this.cancel.setEnabled(1);counterDown.call(this,5)}function UnregisterButton(){this.accept.actionManager.dispose();this.cancel.actionManager.dispose();this.accept.actionManager=null;this.cancel.actionManager=null;this.accept.setEnabled(0);this.cancel.setEnabled(0);ClickCardRegister=false;ClickOneCard=null}function counterDown(count){if(arguments.length>0){if(count>0)this.countdown=count;else this.countdown=0}else if(this.countdown>=0){this.cancel.material.diffuseTexture.drawText("",0,0,"normal 48px Arial","red","black","black",true);this.cancel.material.diffuseTexture.drawText("取",10,50,"normal 48px Arial","red","transparent",true);this.cancel.material.diffuseTexture.drawText("消",70,50,"normal 48px Arial","red","transparent",true);this.cancel.material.diffuseTexture.drawText(this.countdown,50,100,"normal 48px Arial","red","transparent",true);this.countdown--}if(this.countdown<0)return true;else return false}function eatEcardUp(e){forward3Dy.call(e.mesh,.5);rotate3Dx.call(e.mesh,0)}function eatPatternUp(e,p){var j,k;var c,center;center=0;for(k=0;k<p.length;k++){if(e.n==p[k]){continue}for(j=0;j<this.card.length;j++){c=this.card[j];if(c.t==e.t&&c.n==p[k]){forward3Dy.call(c.mesh,.5);center+=c.mesh.position.x;break}}}eatEcardUp(e);return center/2}function pontPatternUp(e){var j;var found;var c,center;found=0;center=0;for(j=0;j<this.card.length;j++){c=this.card[j];if(e.t==c.t&&e.n==c.n){forward3Dy.call(c.mesh,.5);found++;center+=c.mesh.position.x}if(found==2){break}}eatEcardUp(e);return center/2}function gencard(mjx,mjy,mjz,gen){var t,n,i;var fullcard;var mesh;var e;var aname;var box;var multi,matm,mats;var verticesCount;fullcard=[];if(arguments.length>3&&gen){box=genBox(1);box.setEnabled(0);verticesCount=box.getTotalVertices();multi=new BABYLON.MultiMaterial("mjMaterial",globalObj.scene);matm=new BABYLON.StandardMaterial("mjMcolor",globalObj.scene);mats=new BABYLON.StandardMaterial("mjScolor",globalObj.scene);matm.diffuseColor=new BABYLON.Color3(0,0,.5);mats.diffuseColor=new BABYLON.Color3(.5,.5,.5);multi.subMaterials.push(matm);multi.subMaterials.push(mats);k=multi.subMaterials.length;scale3D.call(box,mjx,mjy,mjz);fullcard.row=4;fullcard.col=9;fullcard.depth=4;for(t=0;t<fullcard.row;t++){for(n=0;n<fullcard.col;n++){if(t!=3||n<7){aname=globalObjAddname();mesh=box.clone(aname);switch(t){case 0:multi.subMaterials.push(newTextMaterial(t,n,0,"#aa00aa"));break;case 1:multi.subMaterials.push(newTextMaterial(t,n,0,"#aa8080"));break;case 2:multi.subMaterials.push(newTextMaterial(t,n,0,"#008080"));break;case 3:if(n==4)multi.subMaterials.push(newTextMaterial(t,n,0,"#cc0000"));else if(n==5)multi.subMaterials.push(newTextMaterial(t,n,0,"#00aa00"));else if(n==6)multi.subMaterials.push(newTextMaterial(t,n,0,"#cccccc"));else multi.subMaterials.push(newTextMaterial(t,n,0,"#808080"));break;default:break}mesh.setEnabled(0);mesh.material=multi;mesh.subMeshes=[];mesh.subMeshes.push(new BABYLON.SubMesh(0,0,verticesCount,0,6,mesh));mesh.subMeshes.push(new BABYLON.SubMesh(k,0,verticesCount,6,6,mesh));mesh.subMeshes.push(new BABYLON.SubMesh(1,0,verticesCount,12,24,mesh));k++;e=new onemj(n,t,0);e.mesh=mesh;fullcard.push(e);delete e;for(i=1;i<fullcard.depth;i++){aname=globalObjAddname();e=new onemj(n,t,i);e.mesh=mesh.createInstance(aname);e.mesh.setEnabled(0);fullcard.push(e);delete e}}}}box.dispose();delete box}return fullcard}function card3Ddump(act,forcelast){var cardlen,mesh,fullcard,lastone;var k,dl;var row,col,depth;var tablex,tablez;var tablexoff,tableyoff,tablezoff;var mjspace,mjwidth,mjheight,thickness;var mjx,mjy,mjz;var x,y,z,iwidth;if(arguments.length<2)forcelast=false;tablex=this.tablex;tablez=this.tablez;mjspace=this.mjspace;mjx=this.mjx;mjy=this.mjy;mjz=this.mjz;mjwidth=mjx+mjspace;mjheight=mjy+mjspace;switch(this.id){case 0:if(act>0){thickness=mjz+mjspace;depth=0;col=0;row=0;dl=0;y=mjz/2;fullcard=this.card;cardlen=fullcard.length;for(k=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.setEnabled(0);mesh.rotation=BABYLON.Vector3.Zero();rotate3Dx.call(mesh,270);if(row==1){x=tablex/2-3-dl;z=tablez/2-3}else{if(row==0){x=tablex/2-3.5;z=-tablez/2+2.5+dl}else if(row==2){x=-tablex/2+3.5;z=tablez/2-4-dl}else if(row==3){x=-tablex/2+5+col*mjx/2;z=-tablez/2+2.5+dl}rotate3Dy.call(mesh,90)}move3D.call(mesh,x,y,z);depth++;if(depth==2){depth=0;col++;if(col==17){row++;col=0;dl=0}else dl+=mjwidth;y=mjz/2}else y+=thickness}}fullcard=this.desk;cardlen=fullcard.length;if(cardlen>0){maxcol=10;row=cardlen%maxcol;row=(cardlen-row)/maxcol;z=-tablez/2+5+row*mjheight;y=mjz/2;dl=0;for(k=0,col=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.rotation=BABYLON.Vector3.Zero();rotate3Dx.call(mesh,90);x=-tablex/2+5+dl;move3D.call(mesh,x,y,z);col++;if(col==maxcol){z-=mjheight;col=0;dl=0}else dl=dl+mjwidth}}break;case 1:fullcard=this.card;cardlen=fullcard.length;lastone=cardlen-1;iwidth=mjx+.4;x=-tablex/2+.5;if(act>0||debugGamePlayer)y=mjz/2;else y=mjy/2;z=-tablez/2+1.5;dl=x;for(k=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.rotation=BABYLON.Vector3.Zero();if(k==lastone&&(forcelast||act>1))dl+=mjx;if(act>0||debugGamePlayer)rotate3Dx.call(mesh,90);move3D.call(mesh,dl,y,z);dl+=iwidth}fullcard=this.desk;cardlen=fullcard.length;y=mjz/2;z+=mjheight;for(k=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.rotation=BABYLON.Vector3.Zero();if(fullcard[k].markdown&&act==0)rotate3Dx.call(mesh,270);else rotate3Dx.call(mesh,90);if(fullcard[k].markeat&&act==0)move3D.call(mesh,x,y,z+mjspace);else move3D.call(mesh,x,y,z);x+=mjwidth}break;case 2:fullcard=this.card;cardlen=fullcard.length;lastone=cardlen-1;x=tablex/2-1;y=mjz/2;z=-tablez/2+3;dl=z;for(k=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.rotation=BABYLON.Vector3.Zero();if(k==lastone&&(forcelast||act>1))dl+=mjx;if(act>0||debugGamePlayer)rotate3Dx.call(mesh,90);else rotate3Dx.call(mesh,270);rotate3Dy.call(mesh,270);move3D.call(mesh,x,y,dl);dl+=mjwidth}fullcard=this.desk;cardlen=fullcard.length;x-=mjheight;for(k=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.rotation=BABYLON.Vector3.Zero();rotate3Dy.call(mesh,270);if(fullcard[k].markdown&&act==0)rotate3Dx.call(mesh,270);else rotate3Dx.call(mesh,90);if(fullcard[k].markeat&&act==0)move3D.call(mesh,x-mjspace,y,z);else move3D.call(mesh,x,y,z);z+=mjwidth}break;case 3:fullcard=this.card;cardlen=fullcard.length;lastone=cardlen-1;x=-tablex/2+3;y=mjz/2;z=(tablez-mjheight)/2;dl=x;for(k=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.rotation=BABYLON.Vector3.Zero();if(k==lastone&&(forcelast||act>1))dl+=mjx;if(act>0||debugGamePlayer)rotate3Dx.call(mesh,90);else rotate3Dx.call(mesh,270);rotate3Dy.call(mesh,180);move3D.call(mesh,dl,y,z);dl+=mjwidth}fullcard=this.desk;cardlen=fullcard.length;z-=mjheight;for(k=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.rotation=BABYLON.Vector3.Zero();rotate3Dy.call(mesh,180);if(fullcard[k].markdown&&act==0)rotate3Dx.call(mesh,270);else rotate3Dx.call(mesh,90);if(fullcard[k].markeat&&act==0)move3D.call(mesh,x,y,z-mjspace);else move3D.call(mesh,x,y,z);x+=mjwidth}break;case 4:fullcard=this.card;cardlen=fullcard.length;lastone=cardlen-1;x=-tablex/2+1;y=mjz/2;z=-tablez/2+4;dl=z;for(k=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.rotation=BABYLON.Vector3.Zero();if(k==lastone&&(forcelast||act>1))dl+=mjx;if(act>0||debugGamePlayer)rotate3Dx.call(mesh,90);else rotate3Dx.call(mesh,270);rotate3Dy.call(mesh,90);move3D.call(mesh,x,y,dl);dl+=mjwidth}fullcard=this.desk;cardlen=fullcard.length;x+=mjheight;for(k=0;k<cardlen;k++){mesh=fullcard[k].mesh;mesh.rotation=BABYLON.Vector3.Zero();rotate3Dy.call(mesh,90);if(fullcard[k].markdown&&act==0)rotate3Dx.call(mesh,270);else rotate3Dx.call(mesh,90);if(fullcard[k].markeat&&act==0)move3D.call(mesh,x+mjspace,y,z);else move3D.call(mesh,x,y,z);z+=mjwidth}break;default:break}}function carder(id){var k,tablematerial;var mesh;this.desk=new gencard;this.id=id;this.tablez=16;this.tablex=16;this.mjx=.5;this.mjy=1;this.mjz=.3;this.mjspace=.1;if(id==0){this.card=new gencard(this.mjx,this.mjy,this.mjz,true);this.name="排桌:";this.gungTime=0;this.gungOrder=0;this.score0=300;this.score1=100;this.table=genGround(16,16,12);this.eatsound=newMusic("pong.ogg");this.hulasound=newMusic("hula.ogg");this.playIcon=[];this.listenIcon=[];mesh=genSphere(.2);for(k=0;k<4;k++){this.playIcon[k]=mesh.createInstance(globalObjAddname());this.playIcon[k].setEnabled(0)}this.autoplayIcon=mesh;move3D.call(this.autoplayIcon,7.3,0,-7.3);scale3D.call(this.autoplayIcon,2,2,2);move3D.call(this.playIcon[0],0,0,-4.2);move3D.call(this.playIcon[1],3.5,0,0);move3D.call(this.playIcon[2],0,0,4);move3D.call(this.playIcon[3],-5,0,0);mesh=genCylinder(2,.2,.2);for(k=0;k<4;k++){this.listenIcon[k]=mesh.createInstance(globalObjAddname());this.listenIcon[k].setEnabled(0)}this.autoeatIcon=mesh;scale3D.call(this.autoeatIcon,3,1,3);move3D.call(this.autoeatIcon,0,2,12);move3D.call(this.listenIcon[0],0,0,-7.2);rotate3Dz.call(this.listenIcon[0],90);move3D.call(this.listenIcon[1],8.2,0,0);rotate3Dx.call(this.listenIcon[1],90);move3D.call(this.listenIcon[2],0,0,9.2);rotate3Dz.call(this.listenIcon[2],90);move3D.call(this.listenIcon[3],-8.2,0,0);rotate3Dx.call(this.listenIcon[3],90);tablematerial=newMaterial();tablematerial.backFaceCulling=false;tablematerial.diffuseColor=color3(0,.2,0);this.table.material=tablematerial;move3D.call(this.table,0,-.01,1);this.accept=genPlane(.8);this.accept.material=newMaterial();move3D.call(this.accept,10,2,0);rotate3Dx.call(this.accept,30);this.cancel=this.accept.clone(globalObjAddname());this.cancel.material=newMaterial();move3D.call(this.cancel,11,0,0);rotate3Dx.call(this.cancel,30);this.accept.material.diffuseTexture=new BABYLON.DynamicTexture(globalObjAddname(),128,globalObj.scene,true);this.cancel.material.diffuseTexture=new BABYLON.DynamicTexture(globalObjAddname(),128,globalObj.scene,true);this.autoplay=false;this.autoeat=false;this.countdown=0}else{this.card=new gencard;this.name="玩家"+id+":";this.score=1e4;this.listen=false}}carder.prototype.swap=function(i,j){cardswap.call(this,i,j)};carder.prototype.shuffle=function(){cardshuffle.call(this)};carder.prototype.dump=function(e,forcelast){card3Ddump.call(this,e,forcelast)};carder.prototype.sortmj=function(decend){cardsort.call(this,decend)};carder.prototype.cardeat=function(e){return cardeat.call(this,e)};carder.prototype.cardhula=function(e){return cardhula.call(this,e)};carder.prototype.cardpong=function(e){return cardpong.call(this,e)};carder.prototype.cardgung=function(e){return cardgung.call(this,e)};carder.prototype.selfgung=function(e){return selfgung.call(this,e)};carder.prototype.deskgung=function(e){return deskgung.call(this,e)};carder.prototype.isListen=function(){return isListen.call(this)};carder.prototype.dropToDesk=function(t,pattern,m,n){dropToDesk.call(this,t,pattern,m,n)};carder.prototype.big4lucky=function(e){return big4lucky.call(this,e)};carder.prototype.small4lucky=function(e){return small4lucky.call(this,e)}
;carder.prototype.big3element=function(e){return big3element.call(this,e)};carder.prototype.small3element=function(e){return small3element.call(this,e)};carder.prototype.word3=function(e){return word3.call(this,e)};carder.prototype.samedecal=function(e){return samedecal.call(this,e)};carder.prototype.desknoteat=function(e){return desknoteat.call(this,e)};carder.prototype.pinghu=function(e){return pinghu.call(this,e)};carder.prototype.ponghu=function(e){return ponghu.call(this,e)};carder.prototype.dark345=function(e){return dark345.call(this,e)};Copyright="Copyright (c) masong3000@gmail.com  All rights reserved";debugGamePause=false;debugGamePlayer=false;debugWishCard=false;FuncPlayer=["東","南","西","北"];function mygame(scene,camera,light){var CheckState,NewEcard,MJpk,MJpay,GameState,GotoRender;var GamePause,GameFinish,GameEscape,GameRun;var FuncRun,FuncIndex,FuncCount;var GameTai,GungKaihu,GameHumj;var PauseTime,ShowTime;var tickCounter,eatTimeout,tickTime;var cardstation,play,eatPattern,eatType;var ecard;var j,k,m;ShowTime=100;PauseTime=1e3;tickTime=Math.floor(1e3/ShowTime);GameRun=0;MJpk=0;NewEcard=true;GotoRender=false;FuncRun=0;FuncIndex=0;FuncCount=0;GameFinish=false;GameEscape=false;GameState=99;GamePause=true;cardstation=new carder(0);play=[];for(j=0;j<4;j++){play.push(new carder(j+1))}ClickCardRegister=false;ClickOneCard=null;leftpick.call(cardstation.autoplayIcon,autoplayClick.bind(cardstation));leftpick.call(cardstation.autoeatIcon,autoeatClick.bind(cardstation));function PlayLoop(){var j,k,m;var paid;var ue;var pat,len;var scoretext,runtext;var found;while(!GamePause){if(NewEcard){if(isGameOver.call(cardstation,14)){GamePause=true;break}user=play[MJpk];if(MJpk<2)play[MJpk].sortmj();else play[MJpk].sortmj(false);ecard=cardstation.card.pop();ue=user.selfgung(ecard);if(ue!=null){user.card.push(ecard);pat=[ue.n,ue.n,ue.n,ue.n];user.dropToDesk(ue.t,pat,true);gungStation.call(cardstation);GungKaihu=true;if(DeletePat){delete pat;delete ue}continue}if(user.deskgung(ecard)){user.desk.push(ecard);gungStation.call(cardstation);GungKaihu=true;continue}if(user.cardhula(ecard)){user.card.push(ecard);GameState=1;GameHumj=ecard;GamePause=true;break}GungKaihu=false;user.card.push(ecard);if(debugGamePlayer)BlackBoardDraw(FuncPlayer[MJpk]+"風摸到"+carddecode(ecard));NewEcard=false;forceLastone=true;user.dump(0,forceLastone);CheckState=9;GotoRender=true}else{switch(CheckState){case 12:case 13:if(GameEscape){keepState=CheckState;CheckState=8}if(!ClickCardRegister){cardstation.eatsound.play();RegisterButton.call(cardstation,eatType);tickCounter=tickTime;if(eatType=="碰")px=pontPatternUp.call(play[0],ecard);else px=eatPatternUp.call(play[0],ecard,eatPattern);move3D.call(cardstation.accept,px,1.8,-6);move3D.call(ecard.mesh,px+.8,1.8,-6);move3D.call(cardstation.cancel,px+1.8,1.8,-6)}if(tickCounter>0){eatTimeout=false;tickCounter--}else{eatTimeout=counterDown.call(cardstation);tickCounter=tickTime}if(eatTimeout||ClickOneCard!=null&&ClickOneCard){MJpk=0;play[0].card.push(ecard);play[0].dropToDesk(ecard.t,eatPattern,false,ecard.n);play[0].sortmj();play[0].dump(0);UnregisterButton.call(cardstation);CheckState=9}else if(ClickOneCard!=null&&!ClickOneCard){cardstation.desk.push(ecard);UnregisterButton.call(cardstation);if(CheckState==12)CheckState=3;else CheckState=4;play[0].dump(0);cardstation.dump(0)}GotoRender=true;break;case 9:if(MJpk==0){if(!cardstation.autoplay||ClickCardRegister){if(!ClickCardRegister){RegisterMouseOver(play[0]);cardstation.eatsound.play()}if(ClickOneCard!=null){ecard=play[0].card.pop();cardstation.desk.push(ecard);cardstation.dump(0);play[0].sortmj();play[0].dump(0);if(play[0].isListen()){cardstation.listenIcon[0].setEnabled(1);play[0].listen=true}else{cardstation.listenIcon[0].setEnabled(0);play[0].listen=false}UnregisterMouseOver(play[0]);CheckState=0}GotoRender=true;break}}case 19:user=play[MJpk];if(!user.listen){clone=new Hucardclone(user);if(!clone.listendrop()){clone.dispose();delete clone;clone=new Hucardclone(user);k=clone.listdrop();cardstation.listenIcon[MJpk].setEnabled(0);user.listen=false}else{k=clone.card.length;cardstation.listenIcon[MJpk].setEnabled(1);if(debugGamePlayer)BlackBoardDraw(FuncPlayer[MJpk]+"風聽牌了");user.listen=true}if(k>0){ue=clone.card.pop();for(j=0;j<user.card.length;j++){if(user.card[j].t==ue.t&&user.card[j].n==ue.n){if(j!=user.card.length-1)user.swap(j,user.card.length-1);break}}}else showAlert("case 9: 無法打出牌");clone.dispose();delete clone}ecard=user.card.pop();cardstation.desk.push(ecard);cardstation.dump(0);if(MJpk<2)play[MJpk].sortmj();else play[MJpk].sortmj(false);user.dump(0);CheckState=0;GotoRender=true;if(debugGamePause)GamePause=true;if(GameEscape){keepState=CheckState;CheckState=8}break;case 0:if(GameEscape){keepState=CheckState;CheckState=8}forceLastone=false;ecard=cardstation.desk.pop();CheckState=1;for(k=1;k<4;k++){j=(MJpk+k)%4;if(play[j].cardhula(ecard)){MJpay=MJpk;GameHumj=ecard;MJpk=j;play[j].card.push(ecard);GameState=2;CheckState=0;break}}if(CheckState==1)cardstation.desk.push(ecard);else GamePause=true;break;case 1:if(GameEscape){keepState=CheckState;CheckState=8}ecard=cardstation.desk.pop();CheckState=2;for(k=2;k<4;k++){j=(MJpk+k)%4;if(!play[j].listen&&play[j].cardgung(ecard)){eatPattern=[ecard.n,ecard.n,ecard.n,ecard.n];MJpk=j;play[j].card.push(ecard);play[j].dropToDesk(ecard.t,eatPattern,false);NewEcard=true;play[j].dump(0);CheckState=0;gungStation.call(cardstation);break}}if(CheckState==2)cardstation.desk.push(ecard);else GotoRender=true;break;case 2:if(GameEscape){keepState=CheckState;CheckState=8}ecard=cardstation.desk.pop();CheckState=3;for(k=1;k<4;k++){j=(MJpk+k)%4;if(!play[j].listen&&play[j].cardpong(ecard)){eatPattern=[ecard.n,ecard.n,ecard.n];eatType="碰";if(j==0&&!cardstation.autoeat){CheckState=12}else{MJpk=j;play[j].card.push(ecard);play[j].dropToDesk(ecard.t,eatPattern,false);if(MJpk<2)play[MJpk].sortmj();else play[MJpk].sortmj(false);play[j].dump(0);CheckState=9}break}}if(CheckState==3)cardstation.desk.push(ecard);else GotoRender=true;break;case 3:if(GameEscape){keepState=CheckState;CheckState=8}ecard=cardstation.desk.pop();CheckState=4;j=(MJpk+1)%4;eatPattern=play[j].cardeat(ecard);if(!play[j].listen&&eatPattern!=null){eatType="吃";if(j==0&&!cardstation.autoeat){CheckState=13}else{MJpk=j;play[j].card.push(ecard);play[j].dropToDesk(ecard.t,eatPattern,false,ecard.n);if(MJpk<2)play[MJpk].sortmj();else play[MJpk].sortmj(false);play[j].dump(0);CheckState=9}}if(CheckState==4)cardstation.desk.push(ecard);else GotoRender=true;break;case 4:if(GameEscape){keepState=CheckState;CheckState=8}MJpk=(MJpk+1)%4;NewEcard=true;CheckState=0;GotoRender=true;break;case 8:if(!GameEscape)CheckState=keepState;GotoRender=true;break;default:alert("Code should not be here");NewEcard=true;MJpk=0;CheckState=0;break}}if(GotoRender){GotoRender=false;break}}if(GamePause){switch(GameState){case 88:if(!GameEscape)GameState=pauseState;break;case 0:if(GameEscape){pauseState=GameState;GameState=88}else{for(j=0;j<4;j++){if(j<2)play[j].sortmj();else play[j].sortmj(false);play[j].dump(1)}FuncCount++;runtext="莊家"+FuncPlayer[FuncIndex]+"風 醜莊";BlackBoardDraw(runtext);if(DeletePat)delete runtext;GameState=99}PauseTime=2e3;GotoRender=true;break;case 1:case 2:cardstation.hulasound.play();if(GameEscape==1){pauseState=GameState;GameState=88;GotoRender=true}if(GameState==1){GameTai=1;runtext=FuncPlayer[MJpk]+"風自摸"+carddecode(GameHumj)+"加1台";for(j=0;j<4;j++){if(j==MJpk)play[MJpk].dump(2,true);else play[j].dump(0)}if(isGameOver.call(cardstation,14)){GameTai++;runtext=runtext+"\n海底撈月加1台"}if(play[MJpk].desknoteat(GameHumj)){GameTai+=2;runtext=runtext+"\n門清一摸3"}if(GungKaihu){GameTai++;runtext=runtext+"\n槓上開花加1台"}}else{GameTai=0;runtext=FuncPlayer[MJpk]+"風胡了 "+FuncPlayer[MJpay]+"風"+carddecode(GameHumj);play[MJpk].dump(2);play[MJpay].dump(1);if(isGameOver.call(cardstation,14)){GameTai++;runtext=runtext+"\n海底胡加1台"}if(play[MJpk].desknoteat(GameHumj)){GameTai+=1;runtext=runtext+"\n門清加1台"}if(play[MJpk].pinghu(GameHumj)){GameTai+=2;runtext=runtext+"\n平胡加2台"}if(play[MJpk].ponghu(GameHumj)){GameTai+=2;runtext=runtext+"\n碰碰胡加2台"}if(play[MJpk].card.length==2){GameTai+=1;runtext=runtext+"\n全求人加1台"}}if(play[MJpk].big4lucky(GameHumj)){GameTai+=2;runtext=runtext+"\n大四喜加2台"}if(play[MJpk].small4lucky(GameHumj)){GameTai++;runtext=runtext+"\n小四喜加1台"}if(play[MJpk].big3element(GameHumj)){GameTai+=2;runtext=runtext+"\n大三元加2台"}if(play[MJpk].small3element(GameHumj)){GameTai++;runtext=runtext+"\n小三元加1台"}if(GameState==1)k=play[MJpk].dark345(GameHumj);else k=play[MJpk].dark345(GameHumj,true);if(k==3){GameTai++;runtext=runtext+"\n3暗刻加1台"}else if(k==4){GameTai+=2;runtext=runtext+"\n4暗刻加2台"}else if(k==5){GameTai+=2;runtext=runtext+"\n5暗刻加2台"}k=play[MJpk].word3(GameHumj);if(k>0){GameTai+=k;runtext=runtext+"\n字加"+k+"台"}k=play[MJpk].samedecal(GameHumj);if(k>0){GameTai+=k;runtext=runtext+"\n青/混/字一色加"+k+"台"}if(GameTai>4){GameTai=4;runtext=runtext+"\n滿台最多4台"}if(FuncCount>0){k=FuncCount+FuncCount;if(MJpk==FuncIndex){GameTai+=k;runtext=runtext+"\n連莊"+FuncCount+"加"+k+"台"}else if(MJpay==FuncIndex){GameTai+=k;runtext=runtext+"\n胡連莊"+FuncCount+"加"+k+"台"}}if(GameTai>1){runtext=runtext+"\n總共"+GameTai+"台"}paid=cardstation.score0+GameTai*cardstation.score1;if(GameState==1){for(j=0,m=0;j<4;j++){if(j!=MJpk){k=paid;if(j==FuncIndex&&FuncCount>0){runtext=runtext+"\n"+FuncPlayer[j]+"風連"+FuncCount+"拉"+FuncCount+"加"+(FuncCount+FuncCount)+"台";k=k+(FuncCount+FuncCount)*cardstation.score1}runtext=runtext+"\n"+FuncPlayer[j]+"風付款:"+k+"元";play[j].score-=k;m+=k}}runtext=runtext+"\n"+FuncPlayer[MJpk]+"風進帳:"+m+"元";play[MJpk].score+=m}else{play[MJpay].score-=paid;play[MJpk].score+=paid;runtext=runtext+"\n"+FuncPlayer[MJpay]+"風付款:"+paid+"元";runtext=runtext+"\n"+FuncPlayer[MJpk]+"風進帳:"+paid+"元"}runtext=runtext+"\n\n總計共玩了 "+GameRun+"回合";BlackBoardDraw(runtext);if(DeletePat)delete runtext;for(j=0;j<4;j++){if(play[j].score<0){GameFinish=true;break}}if(FuncIndex==MJpk){FuncCount++}else{FuncCount=0;FuncIndex++;if(FuncIndex==4){FuncIndex=0;FuncRun++;if(FuncRun==4){GameFinish=true;FuncRun=0}}}PauseTime=3e3;GameState=99;GotoRender=true;break;case 99:if(GameEscape){pauseState=GameState;GameState=88;break}if(GameFinish)scoretext="遊戲結束! 積分:";else{scoretext=FuncPlayer[FuncIndex]+"風莊家:";GameRun++;len=cardstation.card.length;k=cardstation.desk.length;for(j=0;j<k;j++){cardstation.card.push(cardstation.desk.pop());len++}for(k=0;k<4;k++){user=play[k];m=user.card.length;for(j=0;j<m;j++){cardstation.card.push(user.card.pop());len++}m=user.desk.length;for(j=0;j<m;j++){cardstation.card.push(user.desk.pop());cardstation.card[len].markdown=false;cardstation.card[len].markeat=false;len++}}cardstation.shuffle();if(len!=136)showAlert("MJ num="+cardstation.card.length+"len="+len);cardstation.dump(1);for(j=0;j<4;j++){if(j==FuncIndex)cardstation.playIcon[j].setEnabled(1);else cardstation.playIcon[j].setEnabled(0);cardstation.listenIcon[j].setEnabled(0);play[j].listen=false}if(FuncCount>0)scoretext=scoretext+"連莊"+FuncCount;scoretext=scoretext+FuncPlayer[FuncRun]+"風圈";scoretext=scoretext+"\n基本胡牌:"+cardstation.score0+"元";scoretext=scoretext+"\n每台加計:"+cardstation.score1+"元"}for(j=0;j<4;j++)scoretext=scoretext+"\n\n"+FuncPlayer[j]+"風"+"籌碼:"+play[j].score+"元";FuncBoardDraw(scoretext);if(DeletePat)delete scoretext;gameDrawIndex=0;gameDrawRun=0;PauseTime=100;GameState=100;GotoRender=true;break;case 100:for(j=0;j<34;j++){cardstation.card[gameDrawIndex+j].mesh.setEnabled(1)}gameDrawIndex+=34;if(gameDrawIndex>=136){gameDrawIndex=0;gameDrawRun=0;PauseTime=100;GameState=101}GotoRender=true;break;case 101:if(GameEscape){pauseState=GameState;GameState=88;break}m=(FuncIndex+gameDrawIndex)%4;for(j=0;j<4;j++)play[m].card.push(cardstation.card.pop());play[m].dump(0);gameDrawIndex++;if(gameDrawIndex==4){gameDrawIndex=0;gameDrawRun++}if(gameDrawRun==4)GameState=102;GotoRender=true;break;case 102:if(GameEscape){pauseState=GameState;GameState=88;break}if(GameFinish){runtext="麻將遊戲結束了!";BlackBoardDraw(runtext);if(DeletePat)delete runtext}gungStation.call(cardstation,true);MJpk=FuncIndex;NewEcard=true;GamePause=false;GameState=0;if(debugWishCard)mjTest(cardstation,play,["三筒","四筒","四筒","五筒","六筒","九筒","九筒","三萬","四萬","五萬","一條","二條","三條","東","東","東","三筒"]);for(j=0;j<4;j++){play[j].sortmj();play[j].dump(0)}PauseTime=100;break;default:GameFinish=true;GotoRender=false;break}if(GotoRender){setTimeout(PlayLoop,PauseTime);GotoRender=false}else if(!GameFinish){setTimeout(PlayLoop,100)}}else{for(j=0;j<4;j++){if(j==MJpk)cardstation.playIcon[j].setEnabled(1);else cardstation.playIcon[j].setEnabled(0)}setTimeout(PlayLoop,ShowTime)}}function PlayStop(){GameEscape=true}function PlayToggle(){if(GameEscape){GameEscape=false}else{GameEscape=true}}function PlayRestart(){GameEscape=false}keyupSet("s",PlayStop);keyupSet(" ",PlayToggle);keyupSet("r",PlayRestart);setTimeout(PlayLoop,100);scene.onPointerDown=function(evt,pickResult){if(pickResult.hit){impact.position.x=pickResult.pickedPoint.x;impact.position.y=pickResult.pickedPoint.y}}}
